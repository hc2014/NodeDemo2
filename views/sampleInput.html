<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>样本登陆</title>
    <script src="/js/jquery-1.7.2.js"></script>
    <script src="/js/jquery.jqGrid.min.js"></script>
    <script src="/js/tool.js"></script>
    <script src="/js/layer.min.js"></script>
    <script src="/js/jquery.cookie.js"></script>
    <script src="/js/jquery-ui-1.11.2.custom/jquery-ui.min.js"></script>
    <script src="/js/My97DatePicker/WdatePicker.js"></script>
    <!--<link href="/js/jquery-ui-1.11.2.custom/jquery-ui.css" rel="stylesheet" />-->
    <link href="/css/simple-demo.css" rel="stylesheet" />
    <script src="/js/dmuploader.min.js"></script>
    <link href="/css/jquery-ui.css" rel="stylesheet" />
    <link href="/css/ui.jqgrid.css" rel="stylesheet" />
    <script type="text/javascript">
        var filesList = new Array();//上传的文件列表
        var exFileList=new Array();//已经存在的文件列表
        var thisFileList=new Array();//本次上传的文件列表
        var moveHeight = 0;

        $(function () {
            //$.removeCookie("testname_history")
            //拖拽 改变div 大小

            $("#imgbox").css('display', 'none');
            $("#line").css('display', 'none');
            $("#showline").css('display', 'none');
            $("#uploaderbox").css('display', 'none');

            bindResize(document.getElementById("imgbox"),document.getElementById("img_rotate"));
            var dragging = false;
            var iY;
            var begingtime_line, endtime_line, timespan_line//用来做用户设置图片自动滚动高度计算的开始和结束时间
            $("#line").mousedown(function (e) {
                dragging = true;
                iY = e.clientY - this.offsetTop;
                this.setCapture && this.setCapture();
                return false;
            });

            //取消原来的document作为事件源 而改成Imgbox成为事件源
            $("#imgbox").mouseover(function(e) {
                var maxHeight = document.getElementById("imgbox").offsetHeight + $("#imgbox").offset().top - 10; //横线可以东区域最大高度
                var minHeight = $("#imgbox").offset().top; //最小高度

                var e = e || window.event;
                var oY = e.clientY - iY;
                if (dragging && oY >= minHeight && oY <= maxHeight) {

                    $("#line").css({
                        "top": oY + "px"
                    }); //{"left":oX + "px", "top":oY + "px"}  只需要y轴移动
                    return false;
                }
            });
            $("#line").mouseup(function (e) {

                var linebeginVal = $("#txt_linebegin").val()
                if ($("#div_helpbox").css("display") == "block") {
                    if (begingtime_line == undefined) {

                        //为了 展开或者关闭 红线的 点击事件 和移动事件冲突
                        var timespan = endtime - begintime
                        if (linebeginVal == "" && timespan > 500) {
                            begingtime_line = new Date();
                            $("#txt_linebegin").val($("#line").offset().top)
                        }
                    } else {
                        if (endtime_line == undefined) {
                            endtime_line = new Date();
                        }
                        timespan_line = endtime_line - begingtime_line;
                        //距离上次拖动 间隔时间操作一秒
                        if (linebeginVal != "" && timespan_line > 1000) {
                            $("#txt_lineend").val($("#line").offset().top)
                        }
                    }
                }
                dragging = false;
                $("#line")[0].releaseCapture;
                e.cancelBubble = true;
            })

            //图片又上角 展开区域相关操作
            $("#div_help").on("click", function () {
                $("#div_helpbox").css("display", "block")
            })
            $("#btn_helpcancel").on("click", function () {
                $("#div_helpbox").css("display", "none")
                $("#txt_linebegin").val("")
                $("#txt_lineend").val("")
            })

            $("#btn_helpreset").on("click", function () {
                begingtime_line = endtime_line = undefined;
                $("#txt_linebegin").val("")
                $("#txt_lineend").val("")
                moveHeight = 0;
            })
            $("#btn_helpsure").on("click", function () {
                $("#div_helpbox").css("display", "none")
                var beginVal = $("#txt_lineend").val()
                var endVal = $("#txt_linebegin").val()
                if (beginVal != "" && endVal != "") {
                    moveHeight = parseInt(endVal) - parseInt(beginVal)
                    moveHeight = Math.abs(moveHeight)
                }
            })

            //红线展开或者隐藏的时候  showline对象的 click事件和 mousedown和mouseup事件有冲突
            //定义两个变量来计算鼠标按下去和起来的时差，如果小于0.5秒就判定是click事件,反之则是红线移动的操作
            var begintime, endtime;
            $("#showline").on("mousedown", function () {
                begintime = new Date();
            })
            $("#showline").on("mouseup", function () {
                endtime = new Date();
                var timespan = endtime - begintime;
                if (timespan < 500) {
                    var type = $(this).attr("type");
                    if (type == "close") {
                        $(this).attr("type", "open").text("<")
                        $("#line").find("hr").css("display", "block")
                    } else {
                        $(this).attr("type", "close").text(">")
                        $("#line").find("hr").css("display", "none")
                    }
                }
            })
            $(document).keyup(function (e) {

                var keycode = e.which;
                var height = moveHeight == 0 ? 200 : moveHeight;
                if (e.altKey && keycode == 38) {
                    var h = $("#imgbox").scrollTop()
                    $("#imgbox").scrollTop(h - height)
                }
                if (e.altKey && keycode == 40) {
                    var h = $("#imgbox").scrollTop()
                    $("#imgbox").scrollTop(h + height)
                }
                if(keycode==113){
                    var msg="";
                            // msg+=="Alt+L:图片左转90度\r\n";
                            // msg+="Alt+R:图片右转90度\r\n";
                            msg+="Alt+N:下一张图片\r\n";
                            msg+="Alt+P:上一张图片\r\n";
                            msg+="Alt+↑:图片向上滚动\r\n";
                            msg+="Alt+↓:图片向下滚动\r\n";
                    alert(msg)
                }
                //R
                // if (e.altKey && keycode == 82) {
                //     rotate('img', 'right')
                // }

                // //L
                // if (e.altKey && keycode == 76) {
                //     rotate('img', 'left')
                // }

                //跳转下一张 alt+N
                if (e.altKey && keycode == 78) {
                    var imgsrc = $("#img").attr("src")
                    $("#canvas_img").remove();//这个时候只有一个canvas叫canvas_img  所以就直接用id来移除了
                      $("#img").removeAttr('style').width(1050)
                    if (imgsrc != "") {
                        filesList.reverse();//先反转 
                        var index = $.inArray(imgsrc, filesList);
                        filesList.reverse()//再转回来
                        index = filesList.length - 1 - index;//得到最后一个索引
                        if (index >= filesList.length - 1) {
                            alert("已经是最后一张了")
                            return false;
                        }
                        $("#img").attr("src", filesList[index + 1]);
                        $("#img2").attr("src", filesList[index + 1]);
                    } else {
                        return false;
                    }
                }

                //P 上一个张
                if(e.altKey&&keycode==80){
                  var imgsrc = $("#img").attr("src")
                  $("#canvas_img").remove();//这个时候只有一个canvas叫canvas_img  所以就直接用id来移除了
                   $("#img").removeAttr('style').width(1050)
                   if(imgsrc!=""){
                        filesList.reverse();//先反转 
                        var index = $.inArray(imgsrc, filesList);
                        filesList.reverse()//再转回来
                        index = filesList.length - 1 - index;//得到最后一个索引
                        if(index==0){
                          alert("已经是第一章了！")
                          return false;
                        }else{
                            $("#img").attr("src", filesList[index - 1]);
                            $("#img2").attr("src", filesList[index - 1]);
                        }
                   }
                }
            });

            $("#right").width($(window).width() - 220);
            $("#right").height($(window).height() - 90);
            bindSelect({ url: '/views/sampleInput.html?type=businessType', data: {}, sourceID: 'drp_ywlx', value: 'ORIGREC', text: 'BUSTYPE', isdefault: false });
            bindSelect({ url: '/views/sampleInput.html?type=getKS', data: {}, sourceID: 'drp_ks', value: 'VALUE', text: 'TEXT', isdefault: true });
            bindSelect({ url: '/views/sampleInput.html?type=getDoctor', data: {}, sourceID: 'drp_doctor', value: 'VALUE', text: 'TEXT', isdefault: true });
            bindSelect({ url: '/views/sampleInput.html?type=getBasicType', data: {}, sourceID: 'drp_basictype', value: 'VALUE', text: 'TEXT', isdefault: true });
            $("#drp_basictype").on("change", function () {

                $("#drp_basictypeinfo").html("");

                bindSelect({
                    url: '/views/sampleInput.html?type=getBasicTypeInfo', data: { fiter: escape($(this).find("option:selected").text()) },
                    sourceID: 'drp_basictypeinfo', value: 'DESCRIPTION', text: 'DESCRIPTION'
                });
            })
            $('#Grid').jqGrid({
                url: '/views/sampleInput.html?type=getSampleList',
                datatype: 'json',
                width: 200,
                mtype: "get",
                height: parseInt($(window).height() - 90),
                rowNum: 999,
                rownumbers: true,
                shrinkToFit: false,
                multiselect: true,
                // multikey:"shiftKey",
                //multiboxonly:true,
                colModel: [
                 { name: 'BARCODE', index: 'BARCODE', label: '样品标签', width: 100, align: 'left' },
                 { name: 'FULLNAME', index: 'FULLNAME', label: '录入人', width: 60, align: 'left' },
                  { name: 'ORIGREC', index: 'ORIGREC', label: 'ORIGREC', width: 60, align: 'left'}
                ],
                onSelectRow: function (id, status) {
                    if (status == true) {
                        BindInfobyGridSelect(id);
                    }
                },
                onSelectAll: function (rowid, status) {
                    if (status == true) {
                        BindInfobyGridSelect(rowid[rowid.length - 1]);
                    }
                },
                loadComplete: function (data) {
                    $("#Grid").setSelection(1);
                    $("#Grid").on("contextmenu",function(e){
                        showGridMenu(e.clientX,e.clientY);
                        return false;
                    })
                },
                gridComplete: function () {
                    var data = $("#Grid").jqGrid("getRowData", 1);
                    loadGroup(data.ORIGREC);
                    //$("#Grid").jqGrid('hideCol','cb');//隐藏 设置多选时候  第一列的checkbox
                },
                xmlReader: {
                    root: 'Items',
                    row: 'Item',
                    page: 'page',
                    total: 'total',
                    repeatitems: false,
                    records: 'records'
                }
            });

            $("#tabs").tabs();
            $("#txt_sjdw").autocomplete({
                source: function (request, response) {
                    $.ajax({
                        url: "/views/sampleInput.html",
                        type: "get",
                        datetype: "json",
                        data: { type: "getSJDW", q: $("#txt_sjdw").val(), max: 50 },
                        success: function (data) {

                            response($.map(eval('(' + data + ')'), function (item) {
                                return {
                                    label: "[" + item.SHORTNAME + "]" + item.COMPNAME,
                                    value: item.RASCLIENTID
                                }
                            }));
                        }
                    })
                },
                minLength: 1
            });


             $('#file_grid').jqGrid({
                //url: '/views/dosomething.html?type=getCloudFile',//默认不加载
                datatype: 'json',
                width: 500,
                mtype: "get",
                height: 380,
                rowNum: 999,
                rownumbers: true,
                shrinkToFit: false,
                multiselect: true,
                colModel: [
                 { name: 'filename', index: 'filename', label: '文件名称', width: 340, align: 'left' },
                 { name: 'type', index: 'type', label: '类型', width: 80, align: 'left' }
                ],
                loadComplete:function(data){
                },
                loadError:function(xhr,status,erro){
                    if(xhr.responseText=="no"){
                        layer.msg("该文件夹为空!",2)
                    }
                },
                 onSelectRow: function (id, status) {
                    if (status == true) {
                         var data = $("#file_grid").jqGrid("getRowData", id);
                         
                         if(data.type=="文件夹"){
                           var path=$.cookie("filepath")?$.cookie("filepath")+"\\"+data.filename:data.filename;
                           console.log("path:"+path)
                            $("#file_grid").jqGrid('setGridParam', { url: 'views/dosomething.html?type=getCloudFile&path='+path, page: 1 }).trigger("reloadGrid")
                            $.cookie("filepath",path)
                            var fileArr=$.cookie("filearr").split(',')
                            console.log("前:"+fileArr)
                            fileArr.push(path)
                             $.cookie("filearr",fileArr)
                             console.log("后:"+$.cookie("filearr"))

                             $("#div_uploadbox").width(512)
                             $("#box_pre_img").css("display","none")
                          }else{
                            var index=layer.load("正在加载...")
                            var filearr=$.cookie("filearr").split(',');
                            var fullpath="";
                            if(filearr.length>=1){
                                fullpath=filearr[filearr.length-1]
                            }
                            $.ajax({
                                url: 'views/dosomething.html',
                                type: 'get',
                                dataType: 'json',
                                data: {type: 'getCloudFile',path:data.filename,fullpath:fullpath },
                            })
                            .done(function(data) {
                                $("#div_uploadbox").width(800);
                                $("#box_pre_img").css("display","block")
                                $("#pre_img").attr('src', '/temp/'+data);
                               layer.close(index)
                            })
                            .fail(function() {
                                console.log("error");
                            })
                            .always(function() {
                                console.log("complete");
                            });
                            
                          }
                       }
                },
                xmlReader: {
                    root: 'Items',
                    row: 'Item',
                    page: 'page',
                    total: 'total',
                    repeatitems: false,
                    records: 'records'
                }
            })

            //删除套餐
            $("#btn_del").on("click", function () {
                var id = $('#Grid1').getGridParam('selrow');
                $('#Grid1').jqGrid('restoreRow', id);//因为在选中行的时候,origrec字段处于编辑状态 ,所以这个时候先把该行重置  这样才能获取origrec
                var origrec = $("#Grid1").jqGrid('getRowData', id).ORIGREC;
                $.ajax({
                    url: "/views/sampleInput.html",
                    type: "get",
                    datetype: "json",
                    data: { type: "delTest", origrec: origrec },
                    success: function (data) {
                        var selectedId = $("#Grid").jqGrid("getGridParam", "selrow");
                        var origrec = $("#Grid").jqGrid("getRowData", selectedId).ORIGREC;
                        $("#Grid1").jqGrid('setGridParam', { url: 'views/sampleInput.html?type=getSampleGroupList&origrec=' + origrec, page: 1 }).trigger("reloadGrid")
                        var msg = eval("(" + data + ")");
                        if (msg.ok) {
                            alert(msg.ok)
                        } else if (msg.err) {
                            alert(msg.err)
                        } else {
                            alert(msg)
                        }
                    }
                })
            })

            $("#btn_delall").on("click", function () {
                var id = $('#Grid').getGridParam('selrow');
                var origrec = $("#Grid").jqGrid('getRowData', id).ORIGREC;
                $.ajax({
                    url: "/views/sampleInput.html",
                    type: "get",
                    datetype: "json",
                    data: { type: "delAllTest", origrec: origrec },
                    success: function (data) {
                        var selectedId = $("#Grid").jqGrid("getGridParam", "selrow");
                        var origrec = $("#Grid").jqGrid("getRowData", selectedId).ORIGREC;
                        $("#Grid1").jqGrid('setGridParam', { url: 'views/sampleInput.html?type=getSampleGroupList&origrec=' + origrec, page: 1 }).trigger("reloadGrid")
                         var msg = eval("(" + data + ")");
                        if (msg.ok) {
                            alert(msg.ok)
                        } else if (msg.err) {
                            alert(msg.err)
                        } else {
                            alert(msg)
                        }
                    }
                })
            })


            $("#a_open").on("click", function () {
                var type = $(this).attr("type");
                var imgsrc = $("#img").attr("src")
                if (type == "open") {
                    $(this).attr('type', 'close').text('打开')
                    $("#imgbox").css('display', 'none');
                    $("#line").css('display', 'none');
                    $("#showline").css('display', 'none');
                    $("#uploaderbox").css('display', 'none');
                } else {
                    $(this).attr('type', 'open').text("关闭")
                    if (imgsrc == "") {
                        $("#uploaderbox").css('display', 'block');
                    } else {
                        $("#imgbox").css('display', 'block')
                        $("#line").css('display', 'block')
                        $("#showline").css('display', 'block')
                    }
                }
            })

            $("#a_upload").on("click", function () {
                $("#a_open").attr('type', 'open').text("关闭")
                $("#uploaderbox").css('display', 'block');
                $("#imgbox").css('display', 'none');
                $("#line").css('display', 'none');
                $("#showline").css('display', 'none');
            })

            $("#btn_closefilebox").on("click",function(){
                $("#div_uploadbox").css("display","none")
                $("#div_uploadbox").width(512)
                $("#box_pre_img").css("display","none")
            })

            $("#btn_subfilebox").on("click", function() {
                var selectedIds = $("#file_grid").jqGrid("getGridParam", "selarrrow");
                var arr = "";
                for (var i in selectedIds) {
                    var row = $("#file_grid").jqGrid('getRowData', selectedIds[i])
                    arr += row.filename + ","
                }
                arr = arr.substr(0, arr.length - 1)
                var filearr = $.cookie("filearr").split(',');
                var fullpath = "";
                if (filearr.length >= 1) {
                    fullpath = filearr[filearr.length - 1]
                }
                $.ajax({
                        url: '/views/dosomething.html',
                        type: 'get',
                        dataType: 'json',
                        data: {
                            type: 'movefile',
                            arr: arr,
                            fullpath:fullpath
                        },
                    })
                    .done(function(data) {
                        var result = eval("(" + data + ")")
                        if (result.ok) {
                            var arrs = arr.split(',')
                            for (var i in arrs) {
                                filesList.push("/upload/" + arrs[i])
                                thisFileList.push("/upload/" + arrs[i])
                            }
                            console.log(filesList)
                            if (filesList.length > 0) {
                                $("#uploaderbox").css("display", "none");
                                $("#imgbox").css("display", "block");
                                $("#line").css("display", "block");
                                $("#showline").css("display", "block");
                                var imgsrc = $("#img").attr("src")
                                if (imgsrc != "") {
                                    filesList.reverse(); //先反转 
                                    var index = $.inArray(imgsrc, filesList);
                                    filesList.reverse() //再转回来
                                    index = filesList.length - 1 - index; //得到最后一个索引
                                    $("#img").attr("src", filesList[index + 1]);
                                    $("#img2").attr("src", filesList[index + 1]);
                                } else {
                                    $("#img").attr("src", filesList[0]);
                                    $("#img2").attr("src", filesList[0]);
                                }
                            }
                            $("#div_uploadbox").css("display", "none")
                            $("#div_uploadbox").width(512)
                            $("#box_pre_img").css("display", "none")

                            showpreimgbox();
                        } else {
                            console.log(result.err)
                        }
                    })
                    .fail(function() {
                        console.log("error");
                    })
                    .always(function() {
                        console.log("complete");
                    });

            })
            $("#a_uploadbox").on("click",function(){
                $("#div_uploadbox").css("display","block")
                //打开自定义上传的时候  清空cookie
                 $.cookie('filepath', '', { expires: -1 });
                  $.cookie('filearr', '', { expires: -1 });
                  $.cookie('filearr', '');//默认空值
                $("#file_grid").jqGrid('setGridParam', { url: 'views/dosomething.html?type=getCloudFile' , page: 1 }).trigger("reloadGrid")
            })
            $("#back").on('click', function(event) {
                var patharr=$.cookie("filearr").split(',')

               if(patharr.length<=1) return;
               patharr.pop();
                var path=patharr[patharr.length-1]
                $.cookie("filearr",patharr)
                $.cookie('filepath', path);

                $("#box_pre_img").css("display","none")
                $("#div_uploadbox").width(512)
                 $("#file_grid").jqGrid('setGridParam', { url: 'views/dosomething.html?type=getCloudFile&path='+path, page: 1 }).trigger("reloadGrid") 
            });
            // Upload Plugin itself
            $('#uploader').dmUploader({
                url: '/views/upload.html',
                dataType: 'json',
                allowedTypes: 'image/*',
                /*extFilter: 'jpg;png;gif',*/
                onInit: function () {
                    console.log("控件加载完成!");
                },
                onBeforeUpload: function (id) {
                    console.log('开始上传第:' + id + "个文件!");
                    update_file_status(id, 'uploading', 'Uploading...');
                },
                onNewFile: function (id, file) {
                    console.log('新文件加入到队列,序号为:' + id);
                    add_file(id, file);
                },
                onComplete: function () {
                    console.log('所有文件上传完成');
                    console.log(filesList)

                    if(exFileList.length>0){
                        alert("你选择的图片:\r\n"+exFileList.toString()+"\r\n已经被录入")
                        exFileList.length=0;
                    }
                   
                    // $.ajax({
                    //      url: '/views/sampleInput.html',
                    //     type: 'get',
                    //     dataType: 'json',
                    //     data: {type:"checkSampleImg",filesList:exFileList.toString()},
                    // })
                    // .done(function(data) {
                    //     console.log(data)
                    // })
                    // .fail(function() {
                    //     console.log("error");
                    // })
                    // .always(function() {
                    //     console.log("complete");
                    // });

                   if(filesList.length>0){
                     $("#uploaderbox").css("display", "none");
                    $("#imgbox").css("display", "block");
                    $("#line").css("display", "block");
                    $("#showline").css("display", "block");
                    var imgsrc = $("#img").attr("src")
                     if (imgsrc != "") {
                        filesList.reverse();//先反转 
                        var index = $.inArray(imgsrc, filesList);
                        filesList.reverse()//再转回来
                        index = filesList.length - 1 - index;//得到最后一个索引
                        $("#img").attr("src", filesList[index + 1]);
                        $("#img2").attr("src", filesList[index + 1]);
                    } else {
                        $("#img").attr("src", filesList[0]);
                        $("#img2").attr("src", filesList[0]);
                    }
                   }
                if (exFileList.length ==thisFileList.length) {
                   return;
                }
                
                showpreimgbox();
                },
                onUploadProgress: function (id, percent) {
                    var percentStr = percent + '%';
                    update_file_progress(id, percentStr);
                },
                onUploadSuccess: function (id, data) {
                    var results=eval("("+data+")")
                    console.log("第:" + id + "文件,上传完成");
                    console.log("服务器返回第:" + id + "个文件的内容是：" + JSON.stringify(results.ok?results.ok:results.exists))
                    update_file_status(id, 'success', 'Upload Complete');
                    update_file_progress(id, '100%');
                    if(results.ok){
                        filesList.push(results.ok);
                        thisFileList.push(results.ok)
                    }
                    else if(results.exists){
                        exFileList.push("\'"+results.exists+"\'")
                    }
                },
                onUploadError: function (id, message) {
                    console.log('第:' + id + '个文件错误: ' + message);
                    update_file_status(id, 'error', message);
                },
                onFileTypeError: function (file) {
                    console.log('File \'' + file.name + '\' cannot be added: must be an image');
                },
                onFileSizeError: function (file) {
                    console.log('File \'' + file.name + '\' cannot be added: size excess limit');
                },
                onFallbackMode: function (message) {
                    alert('Browser not supported(do something else here!): ' + message);
                }
            });

            $("#a_del").on("click", function () {
                var selectedIds = $("#Grid").jqGrid("getGridParam", "selarrrow");
                $.layer({
                    shade: [0],
                    area: ['auto', 'auto'],
                    dialog: {
                        msg: '你确定要删除第' + selectedIds + '行吗？',
                        btns: 2,
                        type: 4,
                        btn: ['确定', '取消'],
                        yes: function (index) {
                            var ids = "";
                            for (var i in selectedIds) {
                                var row = $("#Grid").jqGrid('getRowData', selectedIds[i])
                                ids += row.ORIGREC + ","
                            }
                            ids = ids.substr(0, ids.length - 1)
                            layer.close(index)
                            $.ajax({
                                url: "/views/sampleInput.html",
                                type: "get",
                                datetype: "json",
                                data: { type: "delSampleList", ids: ids },
                                success: function (data) {
                                    $("#Grid").jqGrid('setGridParam', { url: '/views/sampleInput.html?type=getSampleList', page: 1 }).trigger("reloadGrid")
                                    var msg = eval("(" + data + ")");
                                    if (msg.ok) {
                                        alert(msg.ok)
                                    } else if (msg.err) {
                                        alert(msg.err)
                                    } else {
                                        alert(msg)
                                    }
                                }
                            })
                        }, no: function () {
                            return;
                        }
                    }
                });
            })

            $("#a_copy").on("click", function () {

                var sjdw = $("#txt_sjdw").val()
                var barcode = $("#txt_sqdh").val()
                var ywgs = $("#drp_ywgs").find("option:selected").text()
                var ywlx = $("#drp_ywlx").find("option:selected").text()
                var jssj = $("#txt_jssj").val()

                if (sjdw == "" || barcode == "" || ywgs == "" || ywlx == "" || jssj == "") {
                    layer.alert("请先输入送检单位、申请单号、业务归属、业务类型、接受时间!", 1);
                    return;
                }
                var html = "开始编号:<input id='txt_begin' value='" + barcode + "' style='width:100px'/><br />复制个数:<input  type='number' id='txt_copycount' style=' width:100px'/> "
                $.layer({
                    shade: [0],
                    area: ['auto', 'auto'],
                    dialog: {
                        msg: html,
                        btns: 2,
                        type: 4,
                        btn: ['确定', '取消'],
                        yes: function (index) {

                            //需要对起始编号和复制个数 做输入检查  f方法下面已经写好
                            var beginCode = $("#txt_begin").val();
                            var count = $("#txt_copycount").val()
                            if (count < 0 || count == ""||count>=50) {
                                alert("复制个数必须是一个大于0且小于等于50的数字!");
                                $("#txt_copycount").focus();
                                return;
                            }
                            var selectedId = $("#Grid").jqGrid("getGridParam", "selrow");
                            var origrec = $("#Grid").jqGrid("getRowData", selectedId).ORIGREC;
                            $.ajax({
                                url: "/views/sampleInput.html",
                                type: "get",
                                datetype: "json",
                                data: { type: "copySample", beginCode: beginCode, count: count, origrec: origrec },
                                success: function (data) {
                                    alert(data)
                                     $("#Grid").jqGrid('setGridParam', { url: '/views/sampleInput.html?type=getSampleList', page: 1 }).trigger("reloadGrid")
                                },
                                error:function(err){
                                    console.log(err)
                                }
                            })
                            layer.close(index);
                        }, no: function () {
                            return;
                        }
                    }
                });
            })

            $("#txt_begin").on("blur", function () {
                //这里需要对起始编号做个检查
            })

            $("#txt_copycount").on("blur", function () {
                //这里需要对复制个数
            })


            $("#txt_testname").on("focus", function () {
                $(this).select();
            })
            $("#txt_testname").on("keydown", function (e) {
                var val = $(this).val();
                var keycode = e.which;
                if (val == "--" && keycode == 13) {
                    var selectedId = $("#Grid").jqGrid("getGridParam", "selrow");
                    var rows = $("#Grid").jqGrid("getRowData");
                    if (parseInt(selectedId) + 1 <= rows.length) {
                        $("#Grid").setSelection(parseInt(selectedId) + 1);    //设置下一行被选中
                    }
                }
            })
            $("#txt_testname").autocomplete({
                source: function (request, response) {
                    $.ajax({
                        url: "/views/sampleInput.html",
                        type: "get",
                        datetype: "json",
                        data: { type: "getTestName", q: $("#txt_testname").val(), max: 50 },
                        success: function (data) {

                            response($.map(eval('(' + data + ')'), function (item) {
                                return {
                                    label: item.TEXT,
                                    value: item.TEXT,
                                    id: item.VALUE
                                }
                            }));
                        }
                    })
                },
                select: function (e, ui) {
                    addTest(ui.item.id);
                },
                minLength: 1,
                scrollHeight: 20
            });
            $("#txt_barcode").on("blur", function () {
                $.ajax({
                    url: "/views/sampleInput.html",
                    type: "get",
                    data: { type: "CheckBarCode", barcode: $(this).val() },
                    success: function (data) {
                        $("#Grid").jqGrid('setGridParam', { url: '/views/sampleInput.html?type=getSampleList', page: 1 }).trigger("reloadGrid")
                    }
                });
            })

            $("#txt_sjdw").on("blur", function () {
                $.ajax({
                    url: "/views/sampleInput.html",
                    type: "get",
                    data: { type: "CheckSJDW", q: $(this).val() },
                    success: function (data) {
                        if (data < 1) {
                            alert("送检单位不对!");
                            $("#txt_sjdw").val("");
                            $("#txt_sjdw").focus(); 
                        } else {
                            $("#txt_jssj").focus();
                            updateSJDW();
                            bingSampleImg();
                        }
                    }
                });
            })
            
            $("select[multiple]").on("dblclick", function () {
                var selText = $(this).find("option:selected").text();
                var selectedId = $("#Grid").jqGrid("getGridParam", "selrow");
                $.ajax({
                    url: '/views/sampleInput.html',
                    type: "get",
                    data: {
                        type: "addCombonName",
                        text: $("#txt_sjdw").val(),
                        comname: selText,
                        origrec: $("#Grid").jqGrid("getRowData", selectedId).ORIGREC
                    },
                    success: function (data) {
                        var id = $('#Grid').getGridParam('selrow');
                        var origrec = $("#Grid").jqGrid('getRowData', id).ORIGREC;
                        $("#Grid1").jqGrid('setGridParam', { url: 'views/sampleInput.html?type=getSampleGroupList&origrec=' + origrec, page: 1 }).trigger("reloadGrid")
                        alert(data)
                    }
                })
            })

            $("#lb_sjdw").on("dblclick", function () {
                $("#txt_sjdw").val("").removeAttr("disabled");
            })


            $("#lb_jssj").on("dblclick", function () {
                $("#txt_jssj").val("").removeAttr("disabled");
            })

            $("#txt_jssj").on("blur", function () {
                if ($(this).val() == "") {
                    alert("接收时间不对!");
                    $("#txt_jssj").focus();
                }
                else {
                    $.ajax({
                        url: "/views/sampleInput.html",
                        data: { type: "updateJSSJ", barcode: $("#txt_sqdh").val(), jssj: $("#txt_jssj").val() },
                        type: "get",
                        success: function (data) {
                            if (data == "1") {
                                $("#txt_jssj").attr('disabled', 'disabled');
                            }
                        }
                    })
                }
            })
        });

        var lastsel;//上一个选中行
        var groupArr=new Array();
        function loadGroup(id) {
            $('#Grid1').jqGrid({
                url: '/views/sampleInput.html?type=getSampleGroupList&origrec=' + id,
                datatype: 'json',
                width: 630,
                mtype: "get",
                height: 330,
                rowNum: 999,
                shrinkToFit: false,
                colModel: [
                 { name: 'TESTNO', index: 'TESTNO', label: '项目名称', width: 200, align: 'left' },
                 {
                     name: 'SAMPLETYPE', index: 'SAMPLETYPE', label: '项目类型', width: 80, align: 'center', editable: true, edittype: "select", editoptions: {
                         dataUrl: '/views/sampleInput.html?type=getSampleType',
                         buildSelect: function (data) {

                             var response = jQuery.parseJSON(data);
                             var s = '<select>';
                             if (response && response.length) {
                                 for (var i in response) {
                                     s += '<option value="' + response[i].SAMPLE_TYPE + '">' + response[i].SAMPLE_TYPE + '</option>';
                                 }
                             }
                             return s + "</select>";
                         }
                     }
                 },
                { name: 'STRREPORTTIME', index: 'STRREPORTTIME', label: '要求报告时间', width: 60, align: 'right' },
                { name: 'FINALPRICE', index: 'FINALPRICE', label: '签约价格', width: 50, align: 'right' },
                { name: 'DEPT', index: 'DEPT', label: '检测单位', width: 60, align: 'right' },
                { name: 'COMBOTESTNAME', index: 'COMBOTESTNAME', label: '测试名称', width: 150, align: 'right' },
                { name: 'ORIGREC', index: 'ORIGREC', label: 'ORIGREC', width: 150, editable: true, hidden: true }
                ],
                onSelectRow: function (id) {
                    updateRow(id);
                },
                onClickGroup:function(id,status){
                    if(status==false){
                        // console.log(groupArr)
                        //console.log("id:"+id+",index:"+$.inArray(id,groupArr))
                        if($.inArray(id,groupArr)!=-1){
                            groupArr.splice($.inArray(id,groupArr),1)
                        }
                        groupArr.push(id);
                    }else{
                        groupArr.splice($.inArray(id,groupArr),1)
                    }
                },
                gridComplete: function () {
                    var obj = $("#Grid1").jqGrid("getRowData")
                    $("#lb_count").text(obj.length)

                    //数据刷新后 打开之前记录的分组
                    //定义一个新数组
                    var newarr=new Array();
                    for(var i in groupArr){
                        newarr.push(groupArr[i])
                    }
                    for(var i in newarr){
                        $("#Grid1").jqGrid("groupingToggle",newarr[i])
                    }
                },
                grouping: true,
                viewrecords: true,
                groupingView: {
                    groupField: ['COMBOTESTNAME'],
                    groupColumnShow: [true],
                    groupText: ['<b>{0} - {1} Item(s)</b>'],
                    groupCollapse: true
                },
                xmlReader: {
                    root: 'Items',
                    row: 'Item',
                    page: 'page',
                    total: 'total',
                    repeatitems: false,
                    records: 'records'
                }
            });
        }

        function showpreimgbox(){
            var y=$(window).height()
                var x=$(window).width()-270;
               
               var cancel = "<img id='img_cancel' onclick='cancelshowimg()'  style='z-index:200000;cursor:pointer; width:20px;height:20px;position:absolute;right:10px;top:10px'  src='/img/icon/cancel_48.png' />"
                $("#div_showimg").append(cancel)
                $("#div_showimg").css("display", "block").css("position", "absolute").css("top", 0).css("left", 220).css("right", 50).css("z-index", "19999").height(y).width(x)
                    //$("#div_showimg").css("background","#515151").css("opacity","0.3")
                $("#div_showimg").css("overflow-y", "auto")
                $("#div_showimg").bind("scroll", function() {
                    //如果需要这里可以处理 关闭按钮随着滚动条滚动而绝对定位
                })
                
                for (var i = 0; i < thisFileList.length; i++) {
                    var img = "<img id='preview_img_"+i+"'  src='" + thisFileList[i] + "' style='width:" + (x - 16) + "px; height:"+ (x - 16)/4*3+"px' />"
                    $("#div_showimg").append(img);

                     var imgHeight=$("#preview_img_"+i).height();
                     var imgTop=$("#preview_img_"+i).offset().top;
                     var  realTop=imgTop+10;
                     var html='<div id="preview_img_rotate" style=" position: absolute;z-index: 200000;float:right;right:30px;top:'+realTop+'px">';
                     html+='<a href="javascript:void(0);rotate(\'preview_img_'+i+'\', \'left\')"><img title="左转90度" src="/img/icon/left.gif"></a>&nbsp;&nbsp;'
                     html+='<a href="javascript:void(0);rotate(\'preview_img_'+i+'\', \'right\')"><img title="右转90度" src="/img/icon/right.gif"></a>';
                     html+='</div>'
                    $("#div_showimg").append(html);
                }
                var html='<img id=img_hide style="display: none" />'
                $("#div_showimg").append(html);
                $("#a_open").attr('type', 'close').text('打开')
                $("#imgbox").css('display', 'none');
                $("#line").css('display', 'none');
                $("#showline").css('display', 'none');
                $("#uploaderbox").css('display', 'none');

                thisFileList.length=0;
        }
        function bindTabs() {
            if ($("#txt_sjdw").val() == "") return;

            $.ajax({
                url: '/views/sampleInput.html',
                type: "get",
                data: {
                    type: "getCombonName",
                    text: $("#txt_sjdw").val()
                },
                success: function (data) {
                    $("#menu2").html("")
                    var results = eval(data);
                    for (var i in results) {
                        var li = "<option>" + results[i].COMBONAME + "</option>"
                        $("#menu2").append(li)
                    }
                }
            })
            // $.ajax({
            //     url: '/views/sampleInput.html',
            //     type: "get",
            //     data: {
            //         type: "getComUseName",
            //         text: $("#txt_sjdw").val()
            //     },
            //     success: function(data) {
            //         var results = eval(data);
            //         for (var i in results) {
            //             var li = "<li>" + results[i].COMBONAME + "</li>"
            //             $("#menu1").append(li)
            //         }
            //         $("#menu1").menu({
            //                 select: function(e, ui) {
            //                     alert(ui.item.context.innerText)
            //                 }
            //             });
            //     }
            // })
            // $.ajax({
            //     url: '/views/sampleInput.html',
            //     type: "get",
            //     data: {
            //         type: "getTestGroupName",
            //         text: $("#txt_sjdw").val()
            //     },
            //     success: function(data) {
            //         var results = eval(data);
            //         for (var i in results) {
            //             var li = "<li>" + results[i].COMBONAME + "</li>"
            //             $("#menu3").append(li)
            //         }
            //         $("#menu3").menu({
            //                 select: function(e, ui) {
            //                     alert(ui.item.context.innerText)
            //                 }
            //             });
            //     }
            // })
        }
        function updateRow(id) {

            // if (id && id!==lastsel) {
            var rowData = $("#Grid1").jqGrid("getRowData", lastsel === undefined ? id : lastsel);
            //$('#Grid').jqGrid('restoreRow', lastsel);
            saveparameters = {
                keys: true,        //这里按[enter]保存  
                url: "/views/sampleInput.html",
                mtype: "get",
                restoreAfterError: true,
                extraparam: {
                    "type": "updateSampleGroup"
                    //"origrec":rowData.ORIGREC
                },
                afterrestorefunc: function () {
                },
                successfunc: function (response) {
                    //alert(response.responseText);
                    var id = $('#Grid').getGridParam('selrow');
                    var origrec = $("#Grid").jqGrid('getRowData', id).ORIGREC;
                    $("#Grid1").jqGrid('setGridParam', { url: 'views/sampleInput.html?type=getSampleGroupList&origrec=' + origrec, page: 1 }).trigger("reloadGrid")
                },
                errorfunc: function (rowid, res) {
                }
            };

            jQuery("#Grid1").jqGrid('saveRow', lastsel === undefined ? id : lastsel, saveparameters);
            $('#Grid1').jqGrid('editRow', id, saveparameters);
            // }
            lastsel = id;
        }

        var grid_lastsel;
        //Grid选中时绑定数据
        function BindInfobyGridSelect(id) {
            var barcode = $("#Grid").jqGrid('getRowData', id).BARCODE;
            var origrec = $("#Grid").jqGrid('getRowData', id).ORIGREC;
            if(grid_lastsel&&grid_lastsel!=id){
                 var height = moveHeight == 0 ? 0 : moveHeight;
                 var h = $("#imgbox").scrollTop()
                $("#imgbox").scrollTop(h -(parseInt(grid_lastsel)-parseInt(id))*height)
            }
            if($.cookie("testname_history")){
                var testname_history=$.cookie("testname_history").split('↑')
                $("#ul_history").html("")
                  for(var i in testname_history){         
                        var  str=testname_history[i];
                        var obj=JSON.parse(str)
                        var li="<li><a  href='javascript:void(0);selectHistory("+str+""+")'>"+obj.text+"</a></li>";
                        $("#ul_history").append(li)
                  }
            }
            grid_lastsel=id;
            $("#Grid1").jqGrid('setGridParam', { url: 'views/sampleInput.html?type=getSampleGroupList&origrec=' + origrec, page: 1 }).trigger("reloadGrid")
            $.ajax({
                url: '/views/sampleInput.html',
                type: "get",
                data: { type: "getOneSample", barcode: barcode },
                success: function (data) {
                    var sample = eval(data)[0];

                    $("#txt_sqdh").val(sample.BARCODE);
                    $("#drp_ywgs").find("option:contains('" + sample.SAMPLETO + "')").attr("selected", true);
                    $("#drp_ywlx").find("option:contains('" + sample.BUSSINESSTYPE + "')").attr("selected", true);
                    var cyrq = new Date(sample.COLLECTDDATE).Format("yyyy-MM-dd")
                    var sjrq = new Date(sample.SENDDATE).Format("yyyy-MM-dd")
                    var jssj = new Date(sample.COLLECTDDATE).Format("hh:mm:ss")
                    $("#txt_cyrq").val(cyrq);
                    $("#txt_sjrq").val(sjrq);
                    if (sample.SAMPLEFROM != null) {
                        $("#txt_sjdw").val(sample.SAMPLEFROM).attr("disabled", "disabled");
                        $("#txt_jssj").val(jssj).attr("disabled", "disabled");
                    } else {
                        $("#txt_sjdw").val("").removeAttr("disabled");
                        $("#txt_jssj").val("").removeAttr("disabled");
                    }
                    bindTabs()
                }
            });
        }
        function updateSJDW() {
            $.ajax({
                url: "/views/sampleInput.html",
                data: {
                    type: "updateSJDW",
                    barcode: $("#txt_sqdh").val(),
                    sjdw: $("#txt_sjdw").val()
                },
                type: "get",
                success: function (data) {
                    alert(data)
                    if (data == "1") {
                        $("#txt_sjdw").attr("disabled", "disabled")
                    }
                    bindTabs()
                }
            })
        }

        //绑定对应的图片
        function bingSampleImg() {
            var path = $("#img").attr('src') ||"";
            var barcode=$("#txt_sqdh").val();
            console.log(path)
            if (path != "") {
                $.ajax({
                        url: "/views/sampleInput.html",
                        type: 'get',
                        dataType: 'json',
                        data: {
                            type: 'bindImg',
                            barcode:barcode,
                            path:escape(path),
                            moveHeight:moveHeight==0?200:moveHeight
                        }
                    })
                    .done(function() {
                        console.log("success");
                    })
                    .fail(function() {
                        console.log("error");
                    })
                    .always(function() {
                        console.log("complete");
                    });

            }
        }
        function add_file(id, file) {
            var template = '' +
              '<div class="file" id="uploadFile' + id + '">' +
                '<div class="info">' +
                  '#1 - <span class="filename" title="Size: ' + file.size + 'bytes - Mimetype: ' + file.type + '">' + file.name + '</span><br /><small>Status: <span class="status">Waiting</span></small>' +
                '</div>' +
                '<div class="bar">' +
                  '<div class="progress" style="width:0%"></div>' +
                '</div>' +
              '</div>';
            $('#fileList').prepend(template);
        }

        function update_file_status(id, status, message) {
            $('#uploadFile' + id).find('span.status').html(message).addClass(status);
        }

        function showGridMenu(x,y){
            $("#grid_menu").css("display","block").css("position","absolute").css("top",y).css("left",x).css("z-index","9999").css("background","#80ffff").css("height",110)
            $("#grid_menu").css("cursor","pointer")
        }

        function cancelGridMenu(){
            $("#grid_menu").removeAttr('style')
            $("#grid_menu").css("display","none")
        }

        //提交所有
        function saveAllSample(){
            var obj = $("#Grid").jqGrid("getRowData");
            var arr="";
            for (var i = obj.length - 1; i >= 0; i--) {
                arr+=obj.ORIGREC+","
            };
            arr=arr.substr(0,arr.length-1)
            console.log(obj)
            cancelGridMenu();
        }

        //提交选中
        function savSelectSample(){
            var selectedIds = $("#Grid").jqGrid("getGridParam", "selarrrow");
            console.log(selectedIds)
            cancelGridMenu();
        }

        //预览所有
        function showAllImg(){
            var obj = $("#Grid").jqGrid("getRowData");
            var arr="";
            for (var i = obj.length - 1; i >= 0; i--) {
                arr+=obj[i].BARCODE+","
            };
            arr=arr.substr(0,arr.length-1)
            showimg(arr)
        }

        //预览选中
        function showSelectImg() {

            var selectedIds = $("#Grid").jqGrid("getGridParam", "selarrrow");
            var arr="";
            for (var i in selectedIds) {
                var row = $("#Grid").jqGrid('getRowData', selectedIds[i])
                arr += row.BARCODE + ","
            }
             arr = arr.substr(0, arr.length - 1)
             showimg(arr)
        }

        function cancelshowimg(){
            $("#div_showimg").removeAttr('style').html("").css("display","none")
        }
        function showimg(arr){
            //隐藏图片区域
            $("#a_open").attr('type', 'close').text('打开')
            $("#imgbox").css('display', 'none');
            $("#line").css('display', 'none');
            $("#showline").css('display', 'none');
            $("#uploaderbox").css('display', 'none');

            var y=$(window).height()
            var x=$(window).width()-270;
           
            $("#div_showimg").css("display","block").css("position","absolute").css("top",0).css("left",220).css("right",50).css("z-index","19999").height(y).width(x)
            //$("#div_showimg").css("background","#515151").css("opacity","0.3")
            $("#div_showimg").css("overflow-y","auto")
             $("#div_showimg").bind("scroll",function(){
               //如果需要这里可以处理 关闭按钮随着滚动条滚动而绝对定位
            })
            $.ajax({
                 url: "/views/sampleInput.html",
                type: 'get',
                dataType: 'json',
                data: {type: 'getSampleImg',barcodes:arr}
            })
            .done(function(data) {
                $("#div_showimg").html("")
                   var cancel="<img id='img_cancel' onclick='cancelshowimg()'  style='z-index:200000;cursor:pointer; width:20px;height:20px;position:absolute;right:10px;top:10px'  src='/img/icon/cancel_48.png' />"
                    $("#div_showimg").append(cancel)
                for(var i=0;i<data.length;i++){
                    if(i>=1){
                        if(data[i].IMGPATH==data[i-1].IMGPATH){
                            continue;
                        }
                    }
                    var img="<img  src='"+data[i].IMGPATH+"' style='width:"+(x-16)+"px;' />"
                    $("#div_showimg").append(img);
                }
            })
            .fail(function() {
                console.log("error");
            })
            .always(function() {
                console.log("complete");
            });
            


             cancelGridMenu();
        }
        //图片自定义右键菜单
        function showcontextMenu(x,y){
            $("#img_menu").css("display","block").css("position","absolute").css("top",y).css("left",x).css("z-index","20001").css("background","white").css("height",40)
            $("#img_menu").css("cursor","pointer")
        }

        //图片右键取消
        function cancelImg(){
            $("#img_menu").removeAttr('style')
            $("#img_menu").css("display","none")
        }
        //图片右键保存
        function saveImg(){
            var showImgArr=$("img[id^=preview]");
            var path;
            var index= layer.load("正在保存...");
            if(showImgArr.length==0){
                path=$("#img").attr('src');
                saveImg2("img",path,index)
            }else{
               $("img[id^=preview]").each(function(){
                    path=$(this).attr("src")
                    var num=$(this).attr("id").split('_')[2]
                    var obj=$(this).attr("id")
                 if($("#canvas_preview_img_"+num).length>0){
                        saveImg2(obj,path,index)
                }
               })
            }
           
        }
        
        function saveImg2(obj,path,index){
             var canvas = document.getElementById("canvas_"+obj);
          
            var imgData=canvas.toDataURL("image/png");
            $.ajax({
                url: '/views/dosomething.html',
                type: 'POST',
                dataType: 'json',
                data: {
                    type: "saveImg",
                    path: path,
                    imgData: imgData
                }
            })
            .done(function(data) {
                layer.close(index)
               var msg=eval("("+data+")")
               var imgsrc = $("#img").attr("src")
               if(msg.ok){
                    for(var i in filesList){
                        var filename=filesList[i].split('.')[0]
                        if(filename==msg.ok.split('.')[0]){
                            filesList[i]=msg.ok
                        }
                   }
                    $("#img").attr("src",filesList[0])
                    $("#img2").attr("src",filesList[0])
               }else{
                alert(data);
               }
            })
            .fail(function() {
                console.log("error");
            })
            .always(function() {
                $("#img_menu").removeAttr('style')
                $("#img_menu").css("display", "none")
            });
        }
        function update_file_progress(id, percent) {
            $('#uploadFile' + id).find('div.progress').width(percent);
        }

        function selectHistory(obj){
            console.log(obj)
           addTest(obj.id,obj.text,true)
        }

        //id,套餐名称,状态标志   后两个参可不输入，并且是同时不输入    在$("#txt_testname").autocomplete({}})的select方法中调用
        function addTest(id,testname,status){
                var selectedId = $("#Grid").jqGrid("getGridParam", "selrow");
                var origrec = $("#Grid").jqGrid("getRowData", selectedId).ORIGREC;
                var text=testname==null?$("#txt_testname").val():testname;
                $.ajax({
                    url: "/views/sampleInput.html",
                    type: "get",
                    data: { type: "addTest", text: text, code:id, origrec: origrec },
                    success: function (data) {
                        var results = eval("(" + data + ")")
                        if (results.err) {
                            alert(results.err)
                        } else {

                            $("#Grid1").jqGrid('setGridParam', { url: 'views/sampleInput.html?type=getSampleGroupList&origrec=' + origrec, page: 1 }).trigger("reloadGrid")
                            alert(results.ok);
                           if(status==true){
                                return;
                           }
                            var testname_history="";
                            if($.cookie("testname_history")){
                                testname_history=$.cookie("testname_history").split('↑')
                                 var newStr="";//定义一个新的字符串  当历史数据大于5条的时候 会做一个删除的操作  该变量就是用来保存删除以后的数据
                                if(testname_history.length>=5){
                                   testname_history.splice(0,1)
                                   for(var i in testname_history){
                                        newStr+=testname_history[i]+"↑"
                                   }
                                   newStr=newStr.substr(0,newStr.length-1)
                                }
                                var obj={};
                                obj.id=id;
                                obj.text=text;
                                testname_history=newStr==""?$.cookie("testname_history"):newStr;
                                console.log(testname_history)
                                testname_history+="↑"+JSON.stringify(obj)
                            }else{
                                var obj={};
                                obj.id=id;
                                obj.text=text;
                                testname_history+=JSON.stringify(obj);
                            }
                            $.cookie("testname_history",testname_history);
                            console.log($.cookie("testname_history"))
                            $("#ul_history").html("")
                            testname_history=$.cookie("testname_history").split('↑')
                             for (var i in testname_history){
                                    var  str=testname_history[i];
                                    var obj=JSON.parse(str)
                                    var li="<li><a  href='javascript:void(0);selectHistory("+str+""+")'>"+obj.text+"</a></li>";
                                    $("#ul_history").append(li)
                              }
                            
                        }
                    }
                });
        }
        function rotate(obj, arr) {
            var img = document.getElementById(obj);
            if (!img || !arr) return false;
            var n = img.getAttribute('step');
            if (n == null) n = 0;
            if (arr == 'left') {
                (n == 0) ? n = 3 : n--;
            } else if (arr == 'right') {
                (n == 3) ? n = 0 : n++;
            }
            img.setAttribute('step', n);
            //对IE浏览器使用滤镜旋转
            if (document.all) {
                img.style.filter = 'progid:DXImageTransform.Microsoft.BasicImage(rotation=' + n + ')';
                //HACK FOR MSIE 8
                switch (n) {
                    case 0:
                        img.parentNode.style.height = img.height;
                        break;
                    case 1:
                        img.parentNode.style.height = img.width;
                        break;
                    case 2:
                        img.parentNode.style.height = img.height;
                        break;
                    case 3:
                        img.parentNode.style.height = img.width;
                        break;
                }
                // 对现代浏览器写入HTML5的元素进行旋转： canvas
            } else {
                var c = document.getElementById('canvas_'+obj);
                var img2;
                if(obj.split('_').length>1){
                    $("#img_hide").attr("src",$("#"+obj).attr("src"))
                    img2=document.getElementById("img_hide")
                }else{
                    img2 = document.getElementById("img2")
                }
                if (c == null) {
                    img.style.visibility = 'hidden';
                    img.style.position = 'absolute';
                    c = document.createElement('canvas');
                    c.setAttribute("id", 'canvas_' + obj);
                    $(c).on("contextmenu",function(e){
                        showcontextMenu(e.clientX,e.clientY);
                        return false;
                    })
                     if(obj.split('_').length>1){
                        var num=obj.split('_')[2]
                        $(img).after(c)
                     }else{
                        img.parentNode.appendChild(c);
                    }
                }
                var canvasContext = c.getContext('2d');
                $("#canvas_" + obj).width($("#"+obj).width())
                switch (n) {
                    default:
                    case 0:
                        c.setAttribute('width', img2.width);
                        c.setAttribute('height', img2.height);
                        canvasContext.rotate(0 * Math.PI / 180);
                        canvasContext.drawImage(img2, 0, 0);
                        break;
                    case 1:
                        c.setAttribute('width', img2.height);
                        c.setAttribute('height', img2.width);
                        canvasContext.rotate(90 * Math.PI / 180);
                        canvasContext.drawImage(img2, 0, -img2.height);
                        break;
                    case 2:
                        c.setAttribute('width', img2.width);
                        c.setAttribute('height', img2.height);
                        canvasContext.rotate(180 * Math.PI / 180);
                        canvasContext.drawImage(img2, -img2.width, -img2.height);
                        break;
                    case 3:
                        c.setAttribute('width', img2.height);
                        c.setAttribute('height', img2.width);
                        canvasContext.rotate(270 * Math.PI / 180);
                        canvasContext.drawImage(img2, -img2.width, 0);
                        break;
                };
            }
        }
    </script>
    <style>
        .red
        {
            color: red;
        }

        .col1
        {
            text-align: right;
            width: 80px;
        }

        .ui-autocomplete
        {
            max-height: 150px;
            max-width: 300px;
            overflow-y: auto;
            /* prevent horizontal scrollbar */
            overflow-x: hidden;
            /* add padding to account for vertical scrollbar */
            /*padding-right: 20px; */
        }
        /* IE 6 doesn't support max-height 
        * we use height instead, but this forces the menu to always be this tall 
        */
        * html .ui-autocomplete
        {
            height: 150px;
            width: 300px;
        }

        #menu1, #menu2, #menu3
        {
            height: 150px;
            overflow-y: auto;
            width: 310px;
            border: none;
        }
        #ul_history li{
            display:block;
            white-space:nowrap;
        }
          #ul_history a:hover{
            color:red;
          }

          #div_uploadbox{
            position:absolute; 
            top:100px;
            z-index:2121212;
            left:400px;
            width:512;
            height:500px;
            background:#f2f1f0;
           box-shadow:0 0 15px #000;
          }
          #box_foot input{
             width:80px;
             height:30px;
             -webkit-border-radius:5px;
             margin-right:10px;
             margin-top:10px;
          }
    </style>

</head>
<body>
    <div id="top" style="width: 98%; height: 30px; padding: 5px">
        <label class="red">申请单号:</label><input type="text" id="txt_barcode" style="width: 100px;" />
        <input type="button" id="import" value="文件导入" />
        <span style="margin-left: 100px">样本个数<input type="text" style="width: 50px" />
            样本管数<input type="text" style="width: 50px" />
            提交总数<input type="text" style="width: 50px" />
        </span>
        <span style="float: right; margin-right: 30px">
            <a href="#"  id="a_uploadbox">上传</a>
            <a href="#" type="close" id="a_open">打开</a>
            <a href="#" id="a_upload">上传图片</a>
            <a href="#" id="a_selected">提交选中</a>
            <a href="#" id="a_all">提交所有</a>
            <a href="#" id="a_copy">复制</a>
            <a href="#" id="a_del">删除</a>
            <a href="#" id="a_special">特殊样本</a>
        </span>
    </div>
    <div id="left" style="float: left;">
        <table id="Grid">
        </table>
    </div>
    <div id="right" style="float: right;">
        <div id="line" style="position: absolute; z-index: 1000; cursor: move">
            <div id="showline" type="close" style="float: left; background: red; padding: 1px; display: none">></div>
            <hr width="1020px" color="red" size="4" style="display: none" />
        </div>
        <div id="imgbox" style="width: 100%; height: 200px; overflow-y: auto; display: none; cursor: s-resize;">
            <div id="div_help" style="position: absolute; z-index: 1001; right: 20px; background: blue; padding: 1px; cursor: pointer">展开</div>
            <div id="div_helpbox" style="position: absolute; z-index: 1001; right: 20px; padding: 5px; background: gray; display: none">
                起始:<input id="txt_linebegin" type="text" style="width: 50px" /><br />
                结束:<input id="txt_lineend" style="width: 50px" /><br />
                <input type="button" id="btn_helpsure" value="确定" />
                <input type="button" id="btn_helpcancel" value="取消" />
                <input type="button" id="btn_helpreset" value="重置" />
            </div>
            <div id="img_rotate" style=" position: absolute;z-index: 1001;float:right;right:20px;top:215px"><!--$("#top").height()+5+5-200得出top的高度-->
                <a href="javascript:void(0);rotate('img', 'left')"><img title="左转90度" src="/img/icon/left.gif"></a>&nbsp;&nbsp;
                <a href="javascript:void(0);rotate('img', 'right')"><img title="右转90度" src="/img/icon/right.gif"></a>
            </div>
            <img src="" id="img" title="F2可以查看操作图片的一些快捷键" style="width: 1050px">
            <img src="" id="img2" style="display: none" />
        </div>
        <div style="width: 99%; height: 200px;" id="uploaderbox">
            <div style="width: 60%; float: left" id="uploader" class="uploader">
                <div>托放图片到这里</div>
                <div class="or">-或者-</div>
                <div class="browser">
                    <label>
                        <span>点击上传</span>
                        <input type="file" name="files[]" id="files" multiple="multiple" title='Click to add Files'>
                    </label>
                </div>
            </div>
            <div id="fileList" style="height: 200px; width: 39%; float: right;">
            </div>
        </div>
        <fieldset>
            <legend>基本信息</legend>
            <div id="main_left" style="float: left; width: 400px; height: 98%; border: 1px solid gray;">
                <table>
                    <tr>
                        <td class="red col1">
                            <label id="lb_sjdw">送检单位:</label></td>
                        <td>
                            <input id="txt_sjdw" type="text" style="width: 280px" /></td>
                    </tr>
                    <tr>
                        <td class="red col1">申请单号:</td>
                        <td>
                            <input id="txt_sqdh" type="text" style="width: 180px;" disabled="disabled" /></td>
                    </tr>
                    <tr>
                        <td class="red col1">业务归属:</td>
                        <td>
                            <select id="drp_ywgs" style="width: 180px">
                                disabled="disabled"
                                    <option>杭州迪安</option>
                                <option>合作单位</option>
                            </select></td>
                    </tr>
                    <tr>
                        <td class="red col1">业务类型:</td>
                        <td>
                            <select id="drp_ywlx" style="width: 180px"></select></td>
                    </tr>
                    <tr>
                        <td class="col1">采样日期:</td>
                        <td>
                            <input id="txt_cyrq" type="date" style="width: 120px" value="2014-10-29" />
                            <label id="lb_jssj" class="red">接收时间</label><input id="txt_jssj" type="time" style="width: 100px" /></td>
                    </tr>
                    <tr>
                        <td class="col1">病人姓名:</td>
                        <td>
                            <input type="text" style="width: 150px" /></td>
                    </tr>
                    <tr>
                        <td class="col1">性别:</td>
                        <td>
                            <select style="width: 50px">
                                <option>男</option>
                                <option>女</option>
                            </select>年龄<input type="text" style="width: 50px" />
                            <select style="width: 80px">
                                <option>岁</option>
                                <option>月</option>
                                <option>天</option>
                            </select></td>
                    </tr>
                    <tr>
                        <td class="col1">病人类别:</td>
                        <td>
                            <select style="width: 100px">
                                <option>门诊</option>
                                <option>住院</option>
                                <option>体检</option>

                            </select>电话<input type="tel" style="width: 120px" /></td>
                    </tr>
                    <tr>
                        <td class="col1">门/住院号:</td>
                        <td>
                            <input type="text" style="width: 200px" /></td>
                    </tr>
                    <tr>
                        <td class="col1">科室:</td>
                        <td>
                            <select id="drp_ks" style="width: 120px"></select>床号<input type="text" style="width: 80px" /></td>
                    </tr>
                    <tr>
                        <td class="col1">临床诊断:</td>
                        <td>
                            <input type="text" style="width: 180px" /></td>
                    </tr>
                    <tr>
                        <td class="col1">送检医生:</td>
                        <td>
                            <select id="drp_doctor" style="width: 120px"></select>电话<input type="tel" style="width: 80px" /></td>
                    </tr>
                    <tr>
                        <td class="col1">送检日期:</td>
                        <td>
                            <input id="txt_sjrq" type="date" style="width: 120px" value="2014-10-29" /><label>采样时间</label><input type="time" style="width: 80px" /></td>
                    </tr>
                    <tr>
                        <td class="col1">报告方式:</td>
                        <td>
                            <input type="text" style="width: 180px" /><ul id="Ul1">
                                <button>?</button>
                        </td>
                    </tr>
                    <tr>
                        <td class="col1">基本状态:</td>
                        <td>
                            <select id="drp_basictype" style="width: 120px"></select><select id="drp_basictypeinfo" style="width: 120px"></select></td>
                    </tr>
                    <tr>
                        <td class="col1">个数:</td>
                        <td>
                            <input type="number" style="width: 80px;" /><input type="number" style="width: 120px;" /></td>
                    </tr>
                    <tr>
                        <td class="col1">备注:</td>
                        <td>
                            <textarea rows="5" style="width: 180px; resize: none"></textarea>
                            <input type="checkbox" />加急</td>
                    </tr>
                </table>
            </div>
            <div id="main_right1" style="float: right; width: 630px; height: 200px;">
                <div style="width: 300px; height: 180px; float: left;">
                    助记符<input id="txt_testname" type="text" style="width: 180px;" />
                    <button>查找</button>
                   <div id="div_history" style="width: 300px; height: 160px; border:1px solid gray; overflow-x:auto">
                    <ul id="ul_history" style="list-style-type:none;padding-left:5px;">
                    </ul>
                   </div>
                </div>

                <div style="width: 320px; marg <li>1</li>in-right: 10px; height: 200px; float: right;" id="tabs">
                    <ul>
                        <li><a href="#tabs-1">常用测试</a></li>
                        <li><a href="#tabs-2">客户套餐</a></li>
                        <li><a href="#tabs-3">签约套餐</a></li>
                    </ul>
                    <div id="tabs-1">
                        <select multiple="multiple" id="menu1">
                        </select>
                    </div>
                    <div id="tabs-2">
                        <select multiple="multiple" id="menu2">
                        </select>
                    </div>
                    <div id="tabs-3">
                        <select multiple="multiple" id="menu3">
                        </select>
                    </div>
                </div>

            </div>

            <div id="main_right2" style="float: right; margin-top: 10px; width: 630px; height: 350px;">
                <span>当前样本测试总数:</span>
                <label id="lb_count" style="color: blue; font-size: 14"></label>
                <input type="button" style="margin-left: 100px" id="btn_del" value="删除" />
                <input type="button" style="margin-left: 10px" id="btn_delall" value="删除所有" />
                <table id="Grid1">
                </table>
            </div>
            <div id="div_uploadbox"  style="display:none">
                <div id="box_top" >
                    <div style=" width:100%; padding:5px">
                        <a href="javascript:void(0)"><img src="/img/icon/find_file.jpg" title="查找文件"></a>
                        <a id="back" href="javascript:void(0)"><img src="/img/icon/back.jpg" title="后退"></a>
                    </div>
                </div>
                <div id="box_main" style="padding-left:5px;padding-right:5px;float:left">
                    <table id="file_grid"></table>
                </div>
                <div id="box_pre_img" style=" float:right;width:280px;height:370px;display:none">
                    <img id="pre_img"  title="点击查看大图" style="width:250px; height:300px; margin-right:20px; margin-top:50px" />
                </div>
                <div id="box_foot" style="text-align:right;">
                    <input id="btn_closefilebox" type="button" style="background:#fff" value="取消" />
                    <input id="btn_subfilebox" type="button" style="background:#fba480" value="确定" />
                </div>
            </div>
        </fieldset>
    </div>
    <div id="img_menu" style="display:none;">
        <ul style="list-style-type:none;padding-left:5px;margin-top:0px;height:40px">
            <li  onclick="saveImg()"><a href="javascript:void(0)"><img  style="width:15px;height:15px;" src="/img/icon/save.png">保存</a></li>
            <li  onclick="cancelImg()"><a href="javascript:void(0)"><img  style="width:15px;height:15px;" src="/img/icon/cancel2.png">取消</a></li>
        </ul>
    </div>
    <div id="grid_menu" style="display:none;">
        <ul style="list-style-type:none;padding-left:5px;margin-top:0px;height:110px">
            <li  onclick="savSelectSample()"><a href="javascript:void(0)"><img  style="width:15px;height:15px;" src="/img/icon/save.png">提交选中</a></li>
            <li  onclick="saveAllSample()"><a href="javascript:void(0)"><img  style="width:15px;height:15px;" src="/img/icon/save.png">提交所有</a></li>
            <li  onclick="showSelectImg()"><a href="javascript:void(0)"><img  style="width:15px;height:15px;" src="/img/icon/save.png">预览选中</a></li>
            <li  onclick="showAllImg()"><a href="javascript:void(0)"><img  style="width:15px;height:15px;" src="/img/icon/save.png">预览所有</a></li>
            <li  onclick="cancelGridMenu()"><a href="javascript:void(0)"><img  style="width:15px;height:15px;" src="/img/icon/cancel2.png">取消</a></li>
        </ul>
    </div>
    <div id="div_showimg" style="display:none" ></div>

</body>
</html>
